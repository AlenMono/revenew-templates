<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1080, initial-scale=1.0">
    <title>Filter UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            width: 1080px;
            margin: 0 auto;
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        .loader__wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;

            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #c1c1c1d5;
            z-index: 9999
        }

        .card--success {
            display: flex;
            align-items: center;
            justify-content: center;

            padding: 12px 24px;

            background-color: #008555;
            color: #fff;
            border-radius: 4px;
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid;
            border-color: #e74c3c #0000;
            animation: l1 1s infinite;
        }

        @keyframes l1 {
            to {
                transform: rotate(.5turn)
            }
        }

        .card--primary {
            position: relative;

            display: flex;
            flex-direction: column;

            max-width: 1080px;
            margin: 0 auto;

            padding: 16px;

            background-color: #eee;
        }

        .btn--apply {
            padding: 10px 20px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000
        }

        .btn--apply svg {
            transition: all 0.3s ease;
            fill: #000;
        }

        .btn--apply:hover {
            background-color: #000000;
            color: white;
        }

        .btn--apply:hover svg {
            fill: white;
        }

        .btn--clear {
            border: none;
            cursor: pointer;

            color: #555;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn--clear:hover {
            color: #000;
        }

        .filter__footer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-top: 12px;
        }

        .selected {
            border-color: red !important;
            background-color: #ffe;
        }

        .zip-code-input {
            min-width: 200px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .filter-section {
            max-width: 1080px;
            margin: 12px auto;
            background: #eee;
            padding: 20px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            font-weight: bold;
            margin-right: 10px;
        }

        .button-group button,
        .price-group button,
        .cuisine-group button {
            padding: 8px 12px;
            margin: 4px;
            border: 2px solid #000;
            background: #fff;
            cursor: pointer;
            border-radius: 10px;
        }

        .selected {
            border-color: orange;
            background-color: #ffe;
        }

        .stars {
            display: flex;
            gap: 12px;

            font-size: 24px;
            cursor: pointer;
        }

        .star-icon {
            cursor: pointer;
            transition: fill 0.2s;
        }

        .star-icon.selected {
            fill: gold;
            stroke: #000
        }

        .card-opened {
            position: relative;
            border: 2px solid #008555 !important;
            z-index: 1;
        }

        .arrow-bottom {
            display: none;
        }

        .card-opened .arrow-bottom {
            display: block;
        }

        #suggestions {
            display: none;
            list-style: none;
            padding-left: 0;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
            z-index: 10;
        }

        #suggestions li:hover {
            background-color: #f0f0f0;
        }

        .results__list {
            display: grid;
            /* SET AS VARIABLE */
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .results__list__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;

            padding: 16px 12px;

            text-align: center;

            border: 1px solid #1f1f1f;
            background-color: #fff;

            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .results__list__item:hover {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .results__list__item__header {
            width: 100%;

            display: flex;
            align-items: center;
            justify-content: space-between;

            gap: 8px;

            margin-bottom: 6px;
        }

        .results__rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn--primary {
            padding: 12px 24px;

            color: #fff;
            font-weight: bold;
            background-color: #e74c3c;
            border: 1px solid #e74c3c;

            text-decoration: none;
            cursor: pointer;

            transition: all 0.2s ease-in-out;
        }

        .btn--primary:hover {
            background-color: #c0392b;
            border: 1px solid #c0392b;
        }

        .detail-row {
            display: none;
            grid-column: 1 / -1;
        }

        .detail-row.is-open {
            display: block;
        }

        .detail-card {
            display: grid;
            /* SET AS VARIABLE */
            grid-template-columns: 1fr 2fr;
            gap: 20px;

            width: 100%;
            padding: 20px;

            background: #fff;
        }

        .detail-card__media,
        .detail-card__info {
            display: flex;
            flex-direction: column;
            align-items: center;

            gap: 8px;
        }

        .detail-card__info {
            justify-content: space-between;
            align-items: flex-start;
        }

        .hidden {
            display: none;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 316px;
            height: 200px;
            overflow: hidden;
        }

        .slider {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .slide {
            min-width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: none;
            transition: opacity 0.5s ease-in-out;
        }

        .slide.active {
            display: block;
        }

        .arrow {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: black;
            background: white;
            border-radius: 50%;
            padding: 5px 10px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            user-select: none;
        }

        .arrow.left {
            left: 5px;
        }

        .arrow.right {
            right: 5px;
        }

        .arrow.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="filter-section">
        <div
            style="display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; margin-bottom: 16px;">
            <div style="position: relative;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="display: flex; align-items: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#000000"
                            id="Location--Streamline-Tabler-Filled" height="20" width="20">
                            <desc>
                                Location Streamline Icon: https://streamlinehq.com
                            </desc>
                            <path
                                d="M17.409166666666668 1.6716666666666666 17.497500000000002 1.6666666666666667l0.10833333333333334 0.006666666666666667 0.075 0.013333333333333334 0.10250000000000001 0.02916666666666667 0.08916666666666667 0.03833333333333334 0.08333333333333334 0.0475 0.075 0.05583333333333334 0.06833333333333334 0.0625 0.043333333333333335 0.049166666666666664 0.06833333333333334 0.09666666666666668 0.043333333333333335 0.08c0.03916666666666667 0.08333333333333334 0.06416666666666666 0.17166666666666666 0.075 0.26333333333333336l0.004166666666666667 0.08833333333333333c0 0.0625 -0.006666666666666667 0.12416666666666666 -0.02 0.18333333333333335l-0.02916666666666667 0.10250000000000001 -5.443333333333333 15.064166666666669A1.2916666666666667 1.2916666666666667 0 0 1 11.666666666666668 18.6a1.2891666666666666 1.2891666666666666 0 0 1 -1.1075 -0.6225l-0.05416666666666667 -0.10583333333333333 -2.7933333333333334 -5.585 -5.558333333333334 -2.78a1.2916666666666667 1.2916666666666667 0 0 1 -0.7483333333333334 -1.0491666666666666L1.4 8.333333333333334c0 -0.46666666666666673 0.25083333333333335 -0.8933333333333334 0.7008333333333333 -1.1416666666666668l0.11666666666666668 -0.05833333333333334 15.014166666666666 -5.421666666666667 0.08833333333333333 -0.025 0.09 -0.015z"
                                stroke-width="0.8333"></path>
                        </svg>
                    </div>
                    <input type="text" id="cityInput" class="zip-code-input" placeholder="Enter City or Zip Code"
                        autocomplete="off" />

                </div>
                <ul id="suggestions"></ul>
            </div>

            <div>
                <label for="radius">Radius</label>
                <input type="number" id="radius" value="15"
                    style="width: 44px; padding: 6px 8px; border-radius: 6px;" /> miles
            </div>

            <div>
                <label for="sort">Sort by:</label>
                <select id="sort" style="padding: 6px 8px; border-radius: 6px;">
                    <option value="distance">Closest Distance</option>
                    <option value="priceHighLow">Price High/Low</option>
                    <option value="priceLowHigh">Price Low/High</option>
                    <option value="ratingHighLow">Rating High/Low</option>
                </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
                <label>
                    <input type="checkbox" id="openNow" />
                </label>
                <p style="font-size: 14x; font-weight: bold;">
                    Open Now
                </p>
            </div>
        </div>

        <div class="filter-group cuisine-group" style="display: flex; align-items: flex-start; gap: 30px">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label>Cuisine</label>
                <button onclick="selectCuisine(this)"
                    style="padding-left: 30px; padding-right: 30px; white-space: nowrap;">Select All</button>
            </div>

            <div id="cuisineList"></div>
        </div>

        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="price-group">
                <label style="font-weight: bold;">Price</label>
                <button onclick="selectPrice(this)">$</button>
                <button onclick="selectPrice(this)">$$</button>
                <button onclick="selectPrice(this)">$$$</button>
                <button onclick="selectPrice(this)">$$$$</button>
            </div>

            <div class="" style="display: flex; align-items: center; gap: 8px">
                <label style="font-weight: bold;">Minimum Rating</label>
                <div class="stars" id="starRating"></div>
            </div>

            <div style="display: flex; align-items: center; justify-content: flex-end; flex: 1; gap: 12px;">
                <div style="display: flex; justify-content: center;">
                    <button onclick="applyFilter()" class="btn--apply">
                        Apply Filter
                    </button>
                </div>
                <div style="display: flex; justify-content: flex-end;">
                    <button onclick="clearFilter()" class="btn--clear">
                        Clear Filter
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="loader__wrapper">
        <div class="loader"></div>
    </div>

    <div class="card--success" id="successCard" style="display: none;">
        <p>Congratulations! You can now access over 20,000+ restaurant offers.</p>
    </div>

    <div id="toast-container"></div>
    <div class="card--primary" id="restaurantsResult" style="display: none;">
        <!-- Cards will be inserted here by JS -->
        <div class="results__list" id="cardsContainer"></div>

        <div style="display: flex; flex-direction: column; align-items: center; margin-top: 20px;" id="loadMore">
            <button class="btn--primary" onclick="loadMore()">Show More</button>
        </div>
    </div>

    <script>
        const input = document.getElementById("cityInput");
        const suggestions = document.getElementById("suggestions");
        const container = document.getElementById("cardsContainer");
        const starContainer = document.getElementById('starRating');
        const successCard = document.getElementById('successCard');

        const selectedCuisines = new Set();
        const selectedPrices = new Set();
        let restaurants = [];

        let selectedRating = 0;
        let selectedPage = 1;
        let openIndex = null;
        let lat, lon, hasNextPage, debounceTimeout;

        const filledStarSml = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"><path fill="#ffd709" d="M7.709 12.885a.662.662 0 0 1 .582 0l3.542 1.872a.616.616 0 0 0 .897-.65l-.684-4.002a.595.595 0 0 1 .18-.538l2.87-2.769a.605.605 0 0 0-.37-1.042l-3.935-.583a.572.572 0 0 1-.46-.336L8.55 1.239a.605.605 0 0 0-1.098 0L5.669 4.837a.572.572 0 0 1-.46.336l-3.934.583a.605.605 0 0 0-.37 1.042l2.87 2.769a.594.594 0 0 1 .179.538l-.684 4.002a.617.617 0 0 0 .897.65l3.542-1.872Z"/><path fill="#000" fill-rule="evenodd" d="M6.806.93A1.33 1.33 0 0 1 8 .175c.506 0 .978.299 1.193.756l1.756 3.544 3.86.572c.503.05.944.394 1.113.872a1.33 1.33 0 0 1-.33 1.394l-2.831 2.732.673 3.94a1.34 1.34 0 0 1-.53 1.306 1.341 1.341 0 0 1-1.391.105l-.013-.007-3.5-1.85-3.5 1.85a1.342 1.342 0 0 1-1.404-.099 1.341 1.341 0 0 1-.53-1.305l.673-3.94L.41 7.312a1.33 1.33 0 0 1-.33-1.394 1.33 1.33 0 0 1 1.113-.872l3.859-.572L6.806.931Zm2.88 4.214c.185.4.57.681 1.007.737l3.75.555-2.705 2.609c-.32.3-.47.748-.396 1.18l.651 3.808-3.368-1.78a1.383 1.383 0 0 0-1.231-.01.673.673 0 0 0-.02.01l-3.367 1.78.65-3.808.001-.004a1.317 1.317 0 0 0-.395-1.175l-2.705-2.61 3.75-.555c.436-.056.82-.337 1.005-.736L8 1.739l1.687 3.405Z" clip-rule="evenodd"/></svg>
        `

        const filledStar = `
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none"><path fill="#ffd709" d="M12.526 20.938a1.076 1.076 0 0 1 .948 0l5.755 3.041a1.001 1.001 0 0 0 1.458-1.056l-1.112-6.502a.967.967 0 0 1 .292-.875l4.663-4.499a.984.984 0 0 0-.601-1.694l-6.394-.947a.929.929 0 0 1-.746-.546l-2.896-5.847a.984.984 0 0 0-1.786 0L9.211 7.86a.929.929 0 0 1-.746.546l-6.394.947a.983.983 0 0 0-.6 1.694l4.662 4.5a.965.965 0 0 1 .292.874l-1.112 6.502a1.002 1.002 0 0 0 1.458 1.056l5.755-3.041Z"/><path fill="#000" fill-rule="evenodd" d="M11.06 1.513A2.162 2.162 0 0 1 13 .282c.822 0 1.589.486 1.94 1.23l2.852 5.759 6.272.93c.817.08 1.534.64 1.81 1.416a2.162 2.162 0 0 1-.538 2.266l-4.6 4.438 1.094 6.403a2.179 2.179 0 0 1-.861 2.122 2.18 2.18 0 0 1-2.26.171l-.022-.011L13 22l-5.687 3.006a2.18 2.18 0 0 1-2.282-.16 2.18 2.18 0 0 1-.861-2.122l1.094-6.403-4.6-4.438a2.162 2.162 0 0 1-.538-2.266A2.163 2.163 0 0 1 1.937 8.2l6.272-.929 2.852-5.758Zm4.68 6.847c.301.648.926 1.106 1.635 1.196l6.093.903-4.393 4.24h-.002a2.14 2.14 0 0 0-.642 1.916v.001l1.058 6.188-5.473-2.892a2.248 2.248 0 0 0-2.001-.016l-.03.016-5.473 2.892 1.057-6.188.001-.007a2.14 2.14 0 0 0-.642-1.909L2.532 10.46l6.093-.903a2.105 2.105 0 0 0 1.634-1.196L13 2.826l2.74 5.534Z" clip-rule="evenodd"/></svg>
        `;

        const halfStar = `
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="-0.5 -0.5 26 26"><path fill="#8fbffa" d="M12.5 1.562V20.77L7.463 23.27c-1.17.58-2.492-.416-2.327-1.75l.72-5.793-3.848-4.252c-.885-.978-.38-2.585.889-2.833l5.497-1.076 2.669-5.113a1.61 1.61 0 0 1 1.437-.89"/><path fill="#fff" fill-rule="evenodd" d="m12.5 20.77 5.037 2.499c1.17.58 2.492-.416 2.327-1.75l-.72-5.793 3.848-4.252c.885-.978.38-2.585-.889-2.833l-5.497-1.076-2.669-5.113a1.61 1.61 0 0 0-1.437-.89z" clip-rule="evenodd"/><path stroke="#2859c5" stroke-linecap="round" stroke-linejoin="round" d="M12.5 1.562V20.77L7.463 23.27c-1.17.58-2.492-.416-2.327-1.75l.72-5.793-3.848-4.252c-.885-.978-.38-2.585.889-2.833l5.497-1.076 2.669-5.113a1.61 1.61 0 0 1 1.437-.89M12.5 1.562c.31 0 .6.1.873.273M12.5 20.77c.195.097.427.231.687.388m1.887-17.097c.123.243.24.492.351.74.158.352.345.679.56.978m2.578 1.9c.327.11.67.19 1.027.24.322.046.644.1.958.164m2.445 1.095c.196.212.335.458.4.744.074.324.034.659-.089.997m-1.667 2.182c-.23.217-.468.43-.707.636a4.955 4.955 0 0 0-.7.741m-.922 2.899c.012.339.06.683.146 1.029.082.328.16.663.227.997m.045 2.962a1.574 1.574 0 0 1-.582.787 1.568 1.568 0 0 1-.713.26m-2.072-.452c-.244-.107-.49-.227-.734-.354a18.09 18.09 0 0 1-.614-.338"/></svg>
        `

        const outlineStar = `
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none"><path fill="" d="M12.526 20.938a1.076 1.076 0 0 1 .948 0l5.755 3.041a1.001 1.001 0 0 0 1.458-1.056l-1.112-6.502a.967.967 0 0 1 .292-.875l4.663-4.499a.984.984 0 0 0-.601-1.694l-6.394-.947a.929.929 0 0 1-.746-.546l-2.896-5.847a.984.984 0 0 0-1.786 0L9.211 7.86a.929.929 0 0 1-.746.546l-6.394.947a.983.983 0 0 0-.6 1.694l4.662 4.5a.965.965 0 0 1 .292.874l-1.112 6.502a1.002 1.002 0 0 0 1.458 1.056l5.755-3.041Z"/><path fill="#000" fill-rule="evenodd" d="M11.06 1.513A2.162 2.162 0 0 1 13 .282c.822 0 1.589.486 1.94 1.23l2.852 5.759 6.272.93c.817.08 1.534.64 1.81 1.416a2.162 2.162 0 0 1-.538 2.266l-4.6 4.438 1.094 6.403a2.179 2.179 0 0 1-.861 2.122 2.18 2.18 0 0 1-2.26.171l-.022-.011L13 22l-5.687 3.006a2.18 2.18 0 0 1-2.282-.16 2.18 2.18 0 0 1-.861-2.122l1.094-6.403-4.6-4.438a2.162 2.162 0 0 1-.538-2.266A2.163 2.163 0 0 1 1.937 8.2l6.272-.929 2.852-5.758Zm4.68 6.847c.301.648.926 1.106 1.635 1.196l6.093.903-4.393 4.24h-.002a2.14 2.14 0 0 0-.642 1.916v.001l1.058 6.188-5.473-2.892a2.248 2.248 0 0 0-2.001-.016l-.03.016-5.473 2.892 1.057-6.188.001-.007a2.14 2.14 0 0 0-.642-1.909L2.532 10.46l6.093-.903a2.105 2.105 0 0 0 1.634-1.196L13 2.826l2.74 5.534Z" clip-rule="evenodd"/></svg>
        `;

        const debounce = (func, delay) => {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const showLoading = (isLoading) => {
            const loaderWrapper = document.querySelector(".loader__wrapper");

            if (isLoading) {
                loaderWrapper.style.display = "flex";
            } else {
                loaderWrapper.style.display = "none";
            }
        }

        const fetchCities = async (query) => {
            if (!query) {
                suggestions.innerHTML = "";
                input.cityId = null
                return;
            }

            try {
                // const res = await fetch(`{api}OfferCommunication/City?Name=${encodeURIComponent(query)}`, {
                const res = await fetch(`https://api-staging.revenewllc.com/api/OfferCommunication/City?Name=${encodeURIComponent(query)}`, {
                    method: "GET",
                    credentials: 'include',
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Basic ZTUzNGUwM2UtYWQ2NS00MjRhLWI5ZmYtMzc0NmM0NWMxODhhLTM1MDE2OTQ4LTlmZTctNDUzYy05OWQxLTk4NjZmZmIzNDEyYy00MDQ2ODhmNC03NGI2LTRlOTAtYTFhYS1hYmM1NTBjZTRhYTE="
                        // "Authorization": "Basic {apiKey}"
                    }
                });

                const data = await res.json();
                displaySuggestions(data || []);
            } catch (err) {
                console.error("City lookup failed:", err);
            }
        }

        const displaySuggestions = (cities) => {
            suggestions.innerHTML = "";
            suggestions.style.display = cities.length ? "block" : "none";

            cities.forEach((city) => {
                const li = document.createElement("li");
                li.textContent = city.name;

                li.style.cursor = "pointer";
                li.style.padding = "8px 10px";
                li.style.fontSize = "14px";

                li.addEventListener("click", () => {
                    input.cityId = city.id;
                    input.value = city.name;

                    suggestions.innerHTML = "";
                    suggestions.style.display = "none";
                });

                suggestions.appendChild(li);
            });
        }

        input.addEventListener(
            "input",
            debounce((e) => {
                const query = e.target.value.trim();
                fetchCities(query);
            }, 400)
        );

        const selectCuisine = (button) => {
            const allButtons = Array.from(document.querySelectorAll('.cuisine-group button'));
            const cuisineButtons = allButtons.filter(b => b.innerText !== "Select All");

            if (button.innerText === "Select All") {
                const allSelected = cuisineButtons.every(btn => btn.classList.contains('selected'));

                cuisineButtons.forEach(btn => {
                    btn.classList.toggle('selected', !allSelected);
                    if (!allSelected) {
                        selectedCuisines.add(btn.innerText);
                    } else {
                        selectedCuisines.delete(btn.innerText);
                    }
                });

                button.classList.toggle('selected', !allSelected);
                if (!allSelected) {
                    selectedCuisines.add("Select All");
                } else {
                    selectedCuisines.delete("Select All");
                }
            } else {
                button.classList.toggle("selected");

                if (button.classList.contains("selected")) {
                    selectedCuisines.add(button.innerText);
                } else {
                    selectedCuisines.delete(button.innerText);
                }

                const allSelected = cuisineButtons.every(btn => btn.classList.contains('selected'));
                const selectAllBtn = allButtons.find(b => b.innerText === "Select All");

                selectAllBtn.classList.toggle("selected", allSelected);
                if (allSelected) {
                    selectedCuisines.add("Select All");
                } else {
                    selectedCuisines.delete("Select All");
                }
            }
        };

        const selectPrice = (button) => {
            button.classList.toggle("selected");
            const priceLevel = button.innerText.trim().lastIndexOf('$') + 1;

            if (button.classList.contains("selected")) {
                selectedPrices.add(priceLevel);
            } else {
                selectedPrices.delete(priceLevel);
            }
        };

        const renderStars = (rating) => {
            let fullStars = Math.floor(rating);
            const decimal = rating - fullStars;

            let hasHalf = false;

            if (decimal >= 0.3 && decimal <= 0.7) {
                hasHalf = true;
            } else if (decimal > 0.7) {
                fullStars += 1;
            }

            return Array.from({ length: 5 }, (_, i) => {
                const index = i + 1;
                let star = outlineStar;
                if (index <= fullStars) {
                    star = filledStar;
                } else if (index === fullStars + 1 && hasHalf) {
                    star = halfStar;
                }

                return `<span class="star-wrapper" data-index="${index}" style="cursor: pointer; display: inline-block;">${star}</span>`;
            }).join('');
        };

        const updateStars = (rating) => {
            starContainer.innerHTML = renderStars(rating);

            starContainer.querySelectorAll('.star-wrapper').forEach((el) => {
                el.addEventListener('click', () => {
                    const index = parseInt(el.dataset.index);
                    selectedRating = (selectedRating === index) ? 0 : index;
                    updateStars(selectedRating);
                });
            });
        };

        function setRating(rating) {
            selectedRating = selectedRating === rating ? 0 : rating;
            renderStars();
        }

        function applyFilter(isShowMore) {
            showLoading(true);
            const locationId = document.getElementById("cityInput").cityId;
            const radius = document.getElementById("radius").value;
            const sort = document.getElementById("sort").value;
            const openNow = document.getElementById("openNow").checked;

            const filters = {
                lat,
                lon,
                currentTime: new Date().toISOString(),
                locationId,
                radius: parseInt(radius),
                sort,
                openNow,
                cuisines: Array.from(selectedCuisines.has("Select All") ? [] : selectedCuisines),
                priceRange: Array.from(selectedPrices),
                minRating: selectedRating,
                pageNumber: selectedPage,
                pageSize: 21
            };

            fetchRestaurants(filters, isShowMore);
        }

        const fetchRestaurants = async (filters, isShowMore) => {
            //const api = 'http://localhost:60839/api';
            const id = ' Sn8FMPcMnUG39jdxk0ezyw'

            // fetch(`{api}Restaurant/search/{bankCustomerOfferGroupId}`, {
            await fetch(`https://api-staging.revenewllc.com/api/Restaurant/search/Iy8RO_OJdEWDIAnKF67Jcw`, {
                method: "POST",
                body: JSON.stringify({ ...filters }),
                credentials: 'include',
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                    "Authorization": "Basic ZTUzNGUwM2UtYWQ2NS00MjRhLWI5ZmYtMzc0NmM0NWMxODhhLTM1MDE2OTQ4LTlmZTctNDUzYy05OWQxLTk4NjZmZmIzNDEyYy00MDQ2ODhmNC03NGI2LTRlOTAtYTFhYS1hYmM1NTBjZTRhYTE="
                    // "Authorization": "Basic {apiKey}"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    showLoading(false);

                    return response.text().then(text => {
                        if (!text) {
                            console.warn("Empty response body");
                            return {};
                        }
                        return JSON.parse(text);
                    });
                })
                .then(data => {
                    console.log("Filtered Data:", data);

                    showCuisineList(data.cuisine);

                    if (data.restaurants.length > 0) {
                        const combined = [...restaurants, ...data.restaurants];

                        const seen = new Set();
                        restaurants = combined.filter(r => {
                            const key = `${r.name}-${r.address}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        });

                        if (isShowMore) {
                            showRestaurantListCard(restaurants);
                        } else {
                            showRestaurantListCard(data.restaurants);
                        }

                        restaurantsResult.style.display = "block";
                    } else {
                        showToast("Sorry, we didn't find any matches. Please consider broadening your filters or expanding your radius!");
                    }

                    document.getElementById("loadMore").style.display = data.hasNextPage ? "flex" : "none";

                    showLoading(false);
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    showLoading(false);
                });
        }

        const loadMore = () => {
            selectedPage++;
            applyFilter(true);
        }

        function clearFilter() {
            document.getElementById("cityInput").value = "";
            document.getElementById("radius").value = 15;
            document.getElementById("sort").value = "distance";
            document.getElementById("openNow").checked = false;

            document.querySelectorAll(".cuisine-group button, .price-group button").forEach((btn) => {
                btn.classList.remove("selected");
            });

            selectedCuisines.clear();
            selectedPrices.clear();
            setRating(0);
            resetLocation();
        }

        const showCuisineList = (dataArray) => {
            const cuisineList = document.getElementById("cuisineList");
            cuisineList.innerHTML = "";

            dataArray.forEach((item) => {
                const cuisineButton = document.createElement("button");
                cuisineButton.textContent = item;

                if (selectedCuisines.has(item)) {
                    cuisineButton.classList.add("selected");
                }

                cuisineButton.addEventListener("click", () => {
                    selectCuisine(cuisineButton);
                });

                cuisineList.appendChild(cuisineButton);
            });
        };

        function showPosition(position) {
            lat = position.coords.latitude.toFixed(2);
            lon = position.coords.longitude.toFixed(2);

            input.value = "Current Location";
        }

        function resetLocation() {
            input.value = "";
            locationId = null;

            lat = null;
            lon = null;
        }

        function handleError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        const renderPrice = (price) => {
            if (price === null) {
                return '$'
            }
            return '$'.repeat(price);
        };

        const showRestaurantListCard = (data) => {
            container.innerHTML = "";

            data.forEach((restaurant, index) => {
                const card = document.createElement("div");
                card.classList = "results__list__item";

                card.innerHTML = `
                    <div class="results__list__item__header">
                        <div></div>
                        <strong>${restaurant.offerIncentiveCaption}</strong>
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-0.625 -0.625 20 20"><path fill="none" stroke="#000" stroke-miterlimit="10" stroke-width="1.25" d="M1.172 9.375a8.203 8.203 0 1 0 16.406 0 8.203 8.203 0 1 0-16.406 0M4.898 9.375h8.954M9.375 4.898v8.954"/></svg>    
                        </div>
                    </div>
                    <img src="${restaurant.retailerLogoUrl}"
                        alt="" height="100">
                    <strong>${restaurant.retailer}</strong>
                    <div class="results__rating">
                        <div class="stars">
                            ${filledStarSml}
                        </div>
                        <p>${restaurant.ratingAverage.toFixed(1)} (${restaurant.ratingCount})</p>
                        <p>${renderPrice(restaurant.priceRange)}</p>
                    </div>
                    

                    <div style="display: flex; align-items: center; gap: 6px">
                        <div>${restaurant.cuisine}</div>
                        <svg fill="#000000" height="14px" width="14px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                            viewBox="0 0 51.636 51.636" xml:space="preserve">
                            <path d="M51.353,0.914c-0.295-0.305-0.75-0.39-1.135-0.213L0.583,23.481c-0.399,0.184-0.632,0.605-0.574,1.041
                            s0.393,0.782,0.826,0.854l22.263,3.731l2.545,21.038c0.054,0.438,0.389,0.791,0.824,0.865c0.057,0.01,0.113,0.015,0.169,0.015
                            c0.375,0,0.726-0.211,0.896-0.556l24-48.415C51.72,1.675,51.648,1.218,51.353,0.914z"/>
                        </svg>
                        <span>${restaurant.distance}</span>
                    </div>
                    <a href="${restaurant.retailerUrl}" target="_blank" class="btn--primary" style="padding: 12px 40px; font-size: 14px">
                        ${restaurant.buttonCaption}
                    </a>

                     <div class="arrow-bottom"
                        style="position: absolute; bottom: -12px; width:22px; height: 22px; border-left: 2px solid #008555; border-bottom: 2px solid #008555; transform: rotate(-45deg); border-top-right-radius: 50px; background: #fff">
                    </div>
                `;

                card.addEventListener("click", () => {
                    showDetailCard(data, index);
                });

                container.appendChild(card);

                if ((index + 1) % 3 === 0) {
                    const detailRow = document.createElement("div");
                    detailRow.className = "detail-row";
                    container.appendChild(detailRow);
                }
            });
        }

        function showToast(message) {
            const container = document.getElementById("toast-container");

            const toast = document.createElement("div");
            toast.textContent = message;
            toast.style.cssText = `
                text-align: center;
                background-color: #333;
                color: #fff;
                padding: 12px 20px;
                margin-top: 10px;
                border-radius: 5px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                font-family: sans-serif;
                font-size: 14px;
                animation: fadeIn 0.3s ease;
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.transition = "opacity 0.5s ease";
                toast.style.opacity = "0";
                setTimeout(() => toast.remove(), 500);
            }, 10000);
        }

        const showImageSlider = (images) => {
            const imgArr = typeof images === 'string' ? JSON.parse(images) : images;
            const container = document.getElementById("carousel-container");

            if (!container) {
                console.error("No element with ID 'carousel-container' found.");
                return;
            }

            const sliderWrapper = document.createElement("div");
            sliderWrapper.className = "slider-wrapper";

            const leftArrow = document.createElement("div");
            leftArrow.className = "arrow left";
            leftArrow.innerHTML = "&lt;";

            const rightArrow = document.createElement("div");
            rightArrow.className = "arrow right";
            rightArrow.innerHTML = "&gt;";

            const slider = document.createElement("div");
            slider.className = "slider";

            imgArr.forEach((image, index) => {
                const slide = document.createElement("div");

                slide.className = "slide";
                slide.style.backgroundImage = `url(${image})`;

                if (index === 0) slide.classList.add("active");

                slider.appendChild(slide);
            });

            let currentIndex = 0;
            const slides = () => slider.querySelectorAll(".slide");

            const updateArrows = () => {
                leftArrow.classList.toggle("disabled", currentIndex === 0);
                rightArrow.classList.toggle("disabled", currentIndex === imgArr.length - 1);
            };

            const updateSlide = (newIndex) => {
                if (newIndex < 0 || newIndex >= imgArr.length) return;

                slides()[currentIndex].classList.remove("active");

                currentIndex = newIndex;

                slides()[currentIndex].classList.add("active");

                updateArrows();
            };

            leftArrow.addEventListener("click", () => updateSlide(currentIndex - 1));
            rightArrow.addEventListener("click", () => updateSlide(currentIndex + 1));

            updateArrows();

            sliderWrapper.appendChild(leftArrow);
            sliderWrapper.appendChild(slider);
            sliderWrapper.appendChild(rightArrow);
            container.appendChild(sliderWrapper);
        };

        function showDetailCard(data, index) {
            const rowIndex = Math.floor(index / 3);
            let detailRow = document.querySelectorAll(".detail-row")[rowIndex];

            const cardElements = document.querySelectorAll(".results__list__item");

            cardElements.forEach(card => card.classList.remove("card-opened"));

            // If the same card is clicked again, close it
            if (openIndex === index) {
                detailRow.innerHTML = "";
                detailRow.classList.remove("is-open");
                openIndex = null;
                return;
            }

            if (!detailRow) {
                const newDetailRow = document.createElement("div");
                newDetailRow.className = "detail-row";

                const lastCard = cardElements[cardElements.length - 1];
                lastCard.parentNode.insertBefore(newDetailRow, lastCard.nextSibling);

                detailRow = newDetailRow;
            }

            // Close any open detail card
            document.querySelectorAll(".detail-row").forEach(el => el.innerHTML = "");
            detailRow.classList.add("is-open");

            const detailCard = document.createElement("div");
            detailCard.className = "detail-card";

            const {
                retailerUrl,
                buttonCaption,
                menuUrl,
                bookingProviderUrl,
                retailer,
                ratingAverage,
                address,
                city,
                phoneNumber,
                offerIncentiv,
                offerDetails,
                priceRange,
                offerTermsAndConditions,
                offerIncentiveCaption
            } = data[index];

            const renderButton = (url, label) => url ? `<a href="${url}" class="btn--primary" style="padding: 12px 40px; font-size: 14px">${label}</a>` : '';

            const buttonsHTML = `
                <div style="display: flex; justify-content: center; width: 100%; margin-top: 12px; gap: 8px">
                    ${renderButton(retailerUrl, buttonCaption)}
                    ${renderButton(menuUrl, 'View Menu')}
                    ${renderButton(bookingProviderUrl, 'Booking')}
                </div>
            `;

            detailCard.innerHTML = `
                <div class="detail-card__media">                    
                    <div id="carousel-container"></div>

                    <h3>${retailer}</h3>
                    <div class="results__rating">
                        <div class="stars">
                            ${renderStars(ratingAverage)}
                        </div>
                        <p>${ratingAverage.toFixed(1)} (1023)</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="-0.5 -0.5 12 12" id="Navigation-Next-Hexagon-2--Streamline-Cyber" height="50" width="50">
                            <desc>
                                Navigation Next Hexagon 2 Streamline Icon: https://streamlinehq.com
                            </desc>
                            <path stroke="#555" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M3.895833333333333 4.354166666666666h2.2916666666666665V3.208333333333333l2.2916666666666665 2.0625 -2.2916666666666665 2.0625v-1.1458333333333333H4.583333333333333l-2.0625 1.375 1.375 -3.208333333333333Z" stroke-width="1"></path>
                            <path stroke="#555" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="m9.854166666666666 8.25 -4.583333333333333 2.520833333333333 -4.583333333333333 -2.520833333333333V3.208333333333333l4.583333333333333 -2.520833333333333 4.583333333333333 2.520833333333333v5.041666666666666Z" stroke-width="1"></path>
                        </svg>
                        <div style="text-align: center">
                            <p style="color: #555; margin-bottom: 8px;">${address}</p>
                            <p style="color: #555; margin-bottom: 8px;">${city}</p>
                            <p style="color: #555; font-size: 20px; font-weight: 600">${phoneNumber}</p>
                        </div>

                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 6px; padding: 8px; border: 1px solid #555; width: 100%;">
                        ${showWorkingHours(data[index]?.workingHours)}
                    </div>
                </div>
                
                <div class="detail-card__info">
                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 12px;">
                        <div style="width: 100%;">
                            <p style="font-size: 22px; text-align: center;"><strong>${offerIncentiveCaption}</strong></p>
                        </div>
                        
                        ${offerDetails}

                        <div style="display: flex; align-items: center; gap: 12px;">
                            <p style="font-weight: bold;">Price Range:</p>
                            <p>
                                ${renderPrice(priceRange)}
                            </p>
                        </div>

                        ${buttonsHTML}
                    </div>

                    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; margin-top: 24px;">
                        ${offerTermsAndConditions}
                    </div>
                </div>
            `;

            detailRow.appendChild(detailCard);
            openIndex = index;

            cardElements[index].classList.add("card-opened");

            showImageSlider(data[index].images);
        }

        const showWorkingHours = (hours) => {
            const parsedHours = typeof hours === 'string' ? JSON.parse(hours) : hours;

            const fullDayMap = {
                Mon: 'Monday',
                Tue: 'Tuesday',
                Wed: 'Wednesday',
                Thu: 'Thursday',
                Fri: 'Friday',
                Sat: 'Saturday',
                Sun: 'Sunday'
            };

            const html = parsedHours.map(entry => {
                const dayName = fullDayMap[entry.dayOfWeek] || entry.dayOfWeek;
                if (!entry.openForBusiness || !entry.dayHours.length) {
                    return `
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; font-size: 14px">
                            <p>${dayName}</p>
                            <p style="text-align: right">Closed</p>
                        </div>
                    `;
                }

                const hoursStr = entry.dayHours
                    .map(period => `${period.open} – ${period.close}`)
                    .join(', ');

                return `
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; font-size: 14px">
                        <p>${dayName}</p>
                        <p style="text-align: right">${hoursStr}</p>
                    </div>
                `;
            }).join('');

            return html;
        }

        // GET LOCATION 
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        // Initial render
        updateStars(selectedRating);
        setRating(selectedRating);
        applyFilter();
    </script>
</body>

</html>